version: '3.8'

services:
  # 1. The Dashboard (Next.js App)
  web:
    build:
      context: .
      target: runner
    command: node server.js
    environment:
      - PORT=3000
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    ports:
      - "3000:3000"
    restart: always

  # 2. The AI Worker (Background Process)
  worker:
    build:
      context: .
      target: runner
    # We use tsx to run the worker directly. 
    # Make sure 'tsx' is in dependencies, or build it. 
    # Since we copied node_modules, checking if tsx is available in node_modules/.bin
    command: ./node_modules/.bin/tsx src/worker/trader.ts
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
    restart: always
